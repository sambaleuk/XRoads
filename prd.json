{
  "version": "3.0",
  "feature_name": "XRoads Nexus Loop Integration",
  "description": "Système d'actions (loops) avec skills packagés, input interactif, et conformité multi-CLI (Claude, Gemini, Codex)",
  "created_at": "2026-02-03",
  "author": "Nexus",

  "conventions": {
    "unit_tests": {
      "rule": "MANDATORY - Chaque story DOIT inclure ses tests unitaires",
      "location": "Tests/ directory, mirroring source structure",
      "naming": "{ClassName}Tests.swift",
      "coverage_target": "80% minimum pour le code nouveau"
    },
    "test_action_scope": {
      "rule": "L'action .integrationTest ne couvre PAS les TUs",
      "scope": ["integration_tests", "e2e_tests", "performance_tests", "snapshot_tests"],
      "rationale": "TUs sont écrits avec le code (implement), integrationTest = QA avancée"
    }
  },

  "vision": {
    "summary": "Transformer XRoads en orchestrateur de loops spécialisées avec skills contextuels",
    "key_concepts": [
      "Actions = Loops spécialisées (implement, review, integrationTest, write)",
      "Skills = Packages de capacités chargés selon contexte",
      "Conformité = Même interface pour Claude/Gemini/Codex",
      "Frictionless = Auto-détection repo, pas de config manuelle",
      "Interactive = Terminal reçoit input utilisateur (AskClaudeCode)",
      "TDD = Tests unitaires obligatoires avec chaque implémentation"
    ]
  },

  "user_stories": [
    {
      "id": "US-V3-001",
      "title": "Action Type Model & Registry",
      "description": "Define ActionType enum and ActionRegistry for managing available loops",
      "priority": "critical",
      "status": "complete",
      "completed_at": "2026-02-03T15:45:00Z",
      "depends_on": [],
      "acceptance_criteria": [
        "ActionType enum: implement, review, integrationTest, write, custom",
        "Each ActionType has: displayName, iconName, description, requiredSkills",
        "ActionRegistry lists available actions per CLI",
        "Actions are Codable for persistence"
      ],
      "unit_tests": [
        "ActionTypeTests: test all enum cases have valid displayName",
        "ActionTypeTests: test requiredSkills returns non-empty for known actions",
        "ActionRegistryTests: test actions filtered by CLI compatibility",
        "ActionRegistryTests: test custom action registration"
      ],
      "files_to_create": [
        "XRoads/Models/ActionType.swift",
        "XRoads/Services/ActionRegistry.swift",
        "Tests/Models/ActionTypeTests.swift",
        "Tests/Services/ActionRegistryTests.swift"
      ],
      "estimated_complexity": 3
    },
    {
      "id": "US-V3-002",
      "title": "Skill Model & SkillRegistry",
      "description": "Define Skill model and registry for packaged capabilities",
      "priority": "critical",
      "status": "complete",
      "completed_at": "2026-02-03T16:00:00Z",
      "depends_on": ["US-V3-001"],
      "acceptance_criteria": [
        "Skill struct: id, name, description, promptTemplate, requiredTools",
        "SkillRegistry loads from ~/.xroads/skills/ or bundled",
        "Skills have CLI compatibility flags (claude, gemini, codex)",
        "SkillLoader injects skills into AGENT.md"
      ],
      "unit_tests": [
        "SkillTests: test Codable encoding/decoding",
        "SkillTests: test compatibility check for each CLI",
        "SkillRegistryTests: test bundled skills loaded on init",
        "SkillRegistryTests: test custom skill directory loading",
        "SkillLoaderTests: test skill injection into AGENT.md template"
      ],
      "files_to_create": [
        "XRoads/Models/Skill.swift",
        "XRoads/Services/SkillRegistry.swift",
        "XRoads/Services/SkillLoader.swift",
        "Tests/Models/SkillTests.swift",
        "Tests/Services/SkillRegistryTests.swift",
        "Tests/Services/SkillLoaderTests.swift"
      ],
      "estimated_complexity": 5
    },
    {
      "id": "US-V3-003",
      "title": "ActionRunner Service",
      "description": "Central service to execute actions with skill loading",
      "priority": "critical",
      "status": "complete",
      "completed_at": "2026-02-03T16:30:00Z",
      "depends_on": ["US-V3-001", "US-V3-002"],
      "acceptance_criteria": [
        "ActionRunner.run(action:, agent:, worktree:, skills:)",
        "Loads required skills for action",
        "Generates enriched AGENT.md with skills",
        "Launches CLI via AgentLauncher",
        "Works for both Single and Agentic mode"
      ],
      "unit_tests": [
        "ActionRunnerTests: test skill loading for each action type",
        "ActionRunnerTests: test AGENT.md generation includes skills",
        "ActionRunnerTests: test error handling for missing skills",
        "ActionRunnerTests: test CLI launch delegation to AgentLauncher"
      ],
      "files_to_create": [
        "XRoads/Services/ActionRunner.swift",
        "Tests/Services/ActionRunnerTests.swift"
      ],
      "files_to_modify": [
        "XRoads/Services/AgentLauncher.swift"
      ],
      "estimated_complexity": 8
    },
    {
      "id": "US-V3-004",
      "title": "Interactive Terminal Input",
      "description": "Add input bar to terminal slots for stdin interaction",
      "priority": "critical",
      "status": "complete",
      "completed_at": "2026-02-03T17:00:00Z",
      "depends_on": [],
      "acceptance_criteria": [
        "TerminalSlotView has InputBar at bottom",
        "InputBar sends text to ProcessRunner.sendInput()",
        "Supports multi-line input (shift+enter)",
        "Shows 'Agent waiting for input' indicator when needed",
        "Works in both Single and Agentic mode terminals"
      ],
      "unit_tests": [
        "TerminalInputBarTests: test text submission callback",
        "TerminalInputBarTests: test multi-line input detection",
        "TerminalInputBarTests: test disabled state when no process",
        "TerminalSlotViewTests: test input bar visibility toggle"
      ],
      "files_to_create": [
        "XRoads/Views/Components/TerminalInputBar.swift",
        "Tests/Views/TerminalInputBarTests.swift"
      ],
      "files_to_modify": [
        "XRoads/Views/Dashboard/TerminalSlotView.swift",
        "XRoads/Views/Dashboard/TerminalGridLayout.swift"
      ],
      "estimated_complexity": 5
    },
    {
      "id": "US-V3-005",
      "title": "Action Picker UI Component",
      "description": "UI for selecting action type when configuring a slot",
      "priority": "high",
      "status": "complete",
      "completed_at": "2026-02-03T17:30:00Z",
      "depends_on": ["US-V3-001"],
      "acceptance_criteria": [
        "ActionPickerMenu shows available actions",
        "Actions grouped by category (dev, qa, ops)",
        "Shows required skills per action",
        "Disabled if CLI doesn't support required skills",
        "Integrates into TerminalSlotView configuration flow"
      ],
      "unit_tests": [
        "ActionPickerMenuTests: test action filtering by category",
        "ActionPickerMenuTests: test disabled state for incompatible CLI",
        "ActionPickerMenuTests: test selection callback"
      ],
      "files_to_create": [
        "XRoads/Views/Components/ActionPickerMenu.swift",
        "Tests/Views/ActionPickerMenuTests.swift"
      ],
      "files_to_modify": [
        "XRoads/Views/Dashboard/TerminalSlotView.swift"
      ],
      "estimated_complexity": 4
    },
    {
      "id": "US-V3-006",
      "title": "Cross-CLI Skill Adapters",
      "description": "Adapt skill prompts for each CLI's format",
      "priority": "high",
      "status": "complete",
      "completed_at": "2026-02-03T18:00:00Z",
      "depends_on": ["US-V3-002"],
      "acceptance_criteria": [
        "SkillAdapter protocol with adaptSkill(for: AgentType)",
        "ClaudeSkillAdapter handles Claude Code format",
        "GeminiSkillAdapter handles Gemini CLI format",
        "CodexSkillAdapter handles Codex format",
        "Skill templates use {{placeholders}} for adaptation"
      ],
      "unit_tests": [
        "SkillAdapterTests: test placeholder replacement",
        "ClaudeSkillAdapterTests: test Claude-specific formatting",
        "GeminiSkillAdapterTests: test Gemini-specific formatting",
        "CodexSkillAdapterTests: test Codex-specific formatting",
        "SkillAdapterTests: test same skill produces valid output for all CLIs"
      ],
      "files_to_create": [
        "XRoads/Services/SkillAdapters/SkillAdapter.swift",
        "XRoads/Services/SkillAdapters/ClaudeSkillAdapter.swift",
        "XRoads/Services/SkillAdapters/GeminiSkillAdapter.swift",
        "XRoads/Services/SkillAdapters/CodexSkillAdapter.swift",
        "Tests/Services/SkillAdapters/SkillAdapterTests.swift",
        "Tests/Services/SkillAdapters/ClaudeSkillAdapterTests.swift",
        "Tests/Services/SkillAdapters/GeminiSkillAdapterTests.swift",
        "Tests/Services/SkillAdapters/CodexSkillAdapterTests.swift"
      ],
      "estimated_complexity": 6
    },
    {
      "id": "US-V3-007",
      "title": "Frictionless Repo Detection",
      "description": "Auto-detect git repo and offer quick actions",
      "priority": "medium",
      "status": "complete",
      "completed_at": "2026-02-03T18:30:00Z",
      "depends_on": ["US-V3-001"],
      "acceptance_criteria": [
        "On app launch, detect if CWD is git repo",
        "Show QuickStartView with repo info + action buttons",
        "One-click to start action (no worktree sheet)",
        "Auto-create worktree if needed (branch naming convention)",
        "Remember last used repo"
      ],
      "unit_tests": [
        "RepoDetectorTests: test git repo detection",
        "RepoDetectorTests: test non-repo directory handling",
        "QuickActionBarTests: test action button callbacks",
        "QuickActionBarTests: test last repo persistence"
      ],
      "files_to_create": [
        "XRoads/Views/Components/QuickActionBar.swift",
        "XRoads/Services/RepoDetector.swift",
        "Tests/Services/RepoDetectorTests.swift",
        "Tests/Views/QuickActionBarTests.swift"
      ],
      "files_to_modify": [
        "XRoads/Views/Dashboard/GitInfoPanel.swift",
        "XRoads/Views/MainWindowView.swift"
      ],
      "estimated_complexity": 4
    },
    {
      "id": "US-V3-008",
      "title": "Built-in Skill Definitions",
      "description": "Package core skills (commit, review-pr, prd, integration-test, etc.)",
      "priority": "high",
      "status": "pending",
      "depends_on": ["US-V3-002", "US-V3-006"],
      "acceptance_criteria": [
        "Bundled skills: commit, review-pr, prd, integration-test, code-reviewer",
        "Each skill has prompt template + tool requirements",
        "Skills versioned and updatable",
        "User can add custom skills to ~/.xroads/skills/",
        "Skills documented in SKILLS.md"
      ],
      "unit_tests": [
        "BundledSkillsTests: test all bundled skills parse correctly",
        "BundledSkillsTests: test skill version format",
        "BundledSkillsTests: test required tools are valid"
      ],
      "files_to_create": [
        "XRoads/Resources/Skills/commit.skill.json",
        "XRoads/Resources/Skills/review-pr.skill.json",
        "XRoads/Resources/Skills/prd.skill.json",
        "XRoads/Resources/Skills/integration-test.skill.json",
        "XRoads/Resources/Skills/code-reviewer.skill.json",
        "Tests/Resources/BundledSkillsTests.swift"
      ],
      "estimated_complexity": 5
    },
    {
      "id": "US-V3-009",
      "title": "TerminalSlot Model Extension",
      "description": "Extend TerminalSlot to track action and input state",
      "priority": "high",
      "status": "pending",
      "depends_on": ["US-V3-001", "US-V3-004"],
      "acceptance_criteria": [
        "TerminalSlot has actionType: ActionType?",
        "TerminalSlot has loadedSkills: [Skill]",
        "TerminalSlot has needsInput: Bool",
        "TerminalSlot has inputHistory: [String]",
        "Slot status reflects input-waiting state"
      ],
      "unit_tests": [
        "TerminalSlotTests: test isConfigured includes actionType",
        "TerminalSlotTests: test Equatable includes new fields",
        "TerminalSlotTests: test needsInput status transition"
      ],
      "files_to_modify": [
        "XRoads/Models/TerminalSlot.swift"
      ],
      "files_to_create": [
        "Tests/Models/TerminalSlotTests.swift"
      ],
      "estimated_complexity": 3
    },
    {
      "id": "US-V3-010",
      "title": "Implement Loop Action",
      "description": "Create the 'implement' action (PRD → US → code + TUs)",
      "priority": "critical",
      "status": "pending",
      "depends_on": ["US-V3-003", "US-V3-008"],
      "acceptance_criteria": [
        "ImplementAction loads prd.json from repo",
        "Parses user stories and dependencies",
        "Generates implementation plan",
        "Executes code generation WITH unit tests per story",
        "Commits changes per story (code + tests together)"
      ],
      "unit_tests": [
        "ImplementActionTests: test PRD loading and parsing",
        "ImplementActionTests: test dependency ordering",
        "ImplementActionTests: test plan generation format",
        "ImplementActionTests: test story completion tracking"
      ],
      "files_to_create": [
        "XRoads/Actions/ImplementAction.swift",
        "Tests/Actions/ImplementActionTests.swift"
      ],
      "estimated_complexity": 8
    },
    {
      "id": "US-V3-011",
      "title": "Review Loop Action",
      "description": "Create the 'review' action (code reviewer)",
      "priority": "high",
      "status": "pending",
      "depends_on": ["US-V3-003", "US-V3-008"],
      "acceptance_criteria": [
        "ReviewAction analyzes staged/committed changes",
        "Generates review report with issues",
        "Suggests fixes with diff preview",
        "Can auto-fix minor issues",
        "Outputs review.md"
      ],
      "unit_tests": [
        "ReviewActionTests: test diff analysis",
        "ReviewActionTests: test issue categorization",
        "ReviewActionTests: test review.md generation format"
      ],
      "files_to_create": [
        "XRoads/Actions/ReviewAction.swift",
        "Tests/Actions/ReviewActionTests.swift"
      ],
      "estimated_complexity": 6
    },
    {
      "id": "US-V3-012",
      "title": "Integration Test Loop Action",
      "description": "Create the 'integrationTest' action (NOT unit tests - those are in implement)",
      "priority": "high",
      "status": "pending",
      "depends_on": ["US-V3-003", "US-V3-008"],
      "acceptance_criteria": [
        "IntegrationTestAction identifies integration points",
        "Generates integration tests for service boundaries",
        "Generates e2e tests for critical user flows",
        "Can generate performance tests",
        "Does NOT duplicate unit tests (TUs are in implement action)"
      ],
      "unit_tests": [
        "IntegrationTestActionTests: test integration point detection",
        "IntegrationTestActionTests: test e2e flow identification",
        "IntegrationTestActionTests: test no overlap with unit test files"
      ],
      "files_to_create": [
        "XRoads/Actions/IntegrationTestAction.swift",
        "Tests/Actions/IntegrationTestActionTests.swift"
      ],
      "estimated_complexity": 6
    },
    {
      "id": "US-V3-013",
      "title": "ProcessRunner Input Bridge",
      "description": "Expose stdin writing to terminal UI",
      "priority": "critical",
      "status": "pending",
      "depends_on": [],
      "acceptance_criteria": [
        "ProcessRunner exposes sendInput(id:, text:) publicly",
        "AppState tracks processId per slot",
        "TerminalSlotView can call sendInput via binding",
        "Input echoed in terminal output",
        "Handles process not running gracefully"
      ],
      "unit_tests": [
        "ProcessRunnerTests: test sendInput writes to stdin",
        "ProcessRunnerTests: test sendInput error for invalid processId",
        "ProcessRunnerTests: test input echo in output stream"
      ],
      "files_to_modify": [
        "XRoads/Services/ProcessRunner.swift",
        "XRoads/ViewModels/AppState.swift"
      ],
      "files_to_create": [
        "Tests/Services/ProcessRunnerTests.swift"
      ],
      "estimated_complexity": 4
    },
    {
      "id": "US-V3-014",
      "title": "Unified Action Flow (Single & Agentic)",
      "description": "Same action execution path for both modes",
      "priority": "medium",
      "status": "pending",
      "depends_on": ["US-V3-003", "US-V3-009"],
      "acceptance_criteria": [
        "ActionRunner works identically in both modes",
        "Single mode: action on slot[0]",
        "Agentic mode: action per configured slot",
        "Progress/status unified",
        "Logs stream to correct terminal"
      ],
      "unit_tests": [
        "UnifiedFlowTests: test single mode uses slot[0]",
        "UnifiedFlowTests: test agentic mode iterates all configured slots",
        "UnifiedFlowTests: test log routing by slot"
      ],
      "files_to_create": [
        "Tests/Integration/UnifiedFlowTests.swift"
      ],
      "files_to_modify": [
        "XRoads/Views/Dashboard/XRoadsDashboardView.swift",
        "XRoads/Services/ActionRunner.swift"
      ],
      "estimated_complexity": 5
    }
  ],

  "action_definitions": {
    "implement": {
      "id": "implement",
      "displayName": "Implement",
      "icon": "hammer.fill",
      "description": "PRD → User Stories → Code + Unit Tests",
      "includes_unit_tests": true,
      "skills": ["prd", "code-writer", "commit"]
    },
    "review": {
      "id": "review",
      "displayName": "Review",
      "icon": "eye.fill",
      "description": "Analyze code for issues, suggest fixes",
      "includes_unit_tests": false,
      "skills": ["code-reviewer", "lint"]
    },
    "integrationTest": {
      "id": "integrationTest",
      "displayName": "Integration Test",
      "icon": "testtube.2",
      "description": "Generate integration, e2e, and performance tests (NOT unit tests)",
      "includes_unit_tests": false,
      "skills": ["integration-test", "e2e-test", "perf-test"]
    },
    "write": {
      "id": "write",
      "displayName": "Write Docs",
      "icon": "doc.text.fill",
      "description": "Generate documentation, README, API docs",
      "includes_unit_tests": false,
      "skills": ["doc-generator"]
    }
  },

  "implementation_phases": [
    {
      "phase": 1,
      "name": "Core Models & Registry",
      "stories": ["US-V3-001", "US-V3-002", "US-V3-009"],
      "goal": "Define action and skill data structures"
    },
    {
      "phase": 2,
      "name": "Interactive Terminal",
      "stories": ["US-V3-004", "US-V3-013"],
      "goal": "Enable user input in terminal slots"
    },
    {
      "phase": 3,
      "name": "Action Execution",
      "stories": ["US-V3-003", "US-V3-005", "US-V3-014"],
      "goal": "ActionRunner with UI integration"
    },
    {
      "phase": 4,
      "name": "Skill Adapters",
      "stories": ["US-V3-006", "US-V3-008"],
      "goal": "Cross-CLI skill conformity"
    },
    {
      "phase": 5,
      "name": "Built-in Actions",
      "stories": ["US-V3-010", "US-V3-011", "US-V3-012"],
      "goal": "Implement (with TUs), Review, IntegrationTest loops"
    },
    {
      "phase": 6,
      "name": "Frictionless UX",
      "stories": ["US-V3-007"],
      "goal": "Auto-detect and quick-start"
    }
  ],

  "success_metrics": [
    "User can start an action in < 3 clicks",
    "User can respond to agent questions in terminal",
    "Same skill works on Claude, Gemini, and Codex",
    "Actions available in both Single and Agentic modes",
    "Every story implementation includes its unit tests",
    "Integration tests are separate from unit tests"
  ]
}
