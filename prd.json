{
  "version": "4.0",
  "feature_name": "XRoads Multi-CLI Loop System",
  "description": "Systeme de loops multi-CLI (Claude, Gemini, Codex) avec repository de skills, template engine pour conversion cross-CLI, et MCPs dynamiques",
  "created_at": "2026-02-04",
  "author": "Nexus",

  "vision": {
    "summary": "Unifier les loops Nexus pour tous les CLIs avec skills convertibles et MCPs contextuels",
    "key_concepts": [
      "Skills Repository = Source de verite unique pour toutes les capacites",
      "Template Engine = Conversion automatique Claude → Gemini → Codex",
      "gemini-loop = Loop basee sur Ralph avec patterns Nexus",
      "Dynamic MCPs = AgentBrowser (tests), Supabase (projet), XRoads (logging)",
      "Injection Startup = Skills charges au demarrage de session"
    ]
  },

  "architecture": {
    "skills_repository": {
      "location": "~/.xroads/skills/",
      "structure": {
        "core/": "Skills essentiels (commit, review-pr, prd, test-writer)",
        "automation/": "Skills d'automatisation (agent-browser, supabase-query)",
        "project/": "Skills specifiques au projet (charges via .xroads/skills.json)"
      },
      "format": {
        "extension": ".skill.yaml",
        "schema": {
          "id": "string - identifiant unique",
          "name": "string - nom affichable",
          "version": "string - semver",
          "description": "string - description",
          "category": "string - core|automation|project",
          "templates": {
            "claude": "string - format Claude Code (slash commands)",
            "gemini": "string - format Gemini CLI (hooks/extensions)",
            "codex": "string - format Codex (playbook entries)"
          },
          "required_tools": ["string - outils MCP requis"],
          "mcp_dependencies": ["string - MCPs a charger"],
          "env_vars": ["string - variables d'environnement requises"]
        }
      }
    },

    "template_engine": {
      "purpose": "Convertir skills entre formats CLI",
      "location": "~/.xroads/lib/skill-converter.sh",
      "conversions": {
        "claude_to_gemini": {
          "slash_command": "gemini_hook",
          "mcp_tool_use": "gemini_extension_call",
          "prompt_format": "gemini_system_instruction"
        },
        "claude_to_codex": {
          "slash_command": "playbook_ritual",
          "mcp_tool_use": "codex_exec_mcp",
          "prompt_format": "playbook_section"
        }
      }
    },

    "mcp_configuration": {
      "static_mcps": {
        "xroads-mcp": {
          "purpose": "Logging et status vers XRoads UI",
          "always_loaded": true,
          "path": "~/Projets/CrossRoads/xroads-mcp/build/index.js"
        }
      },
      "dynamic_mcps": {
        "agent-browser": {
          "purpose": "E2E testing et web automation",
          "auto_load_when": "skill requires browser automation",
          "config": "~/.xroads/mcp/agent-browser.json"
        },
        "supabase": {
          "purpose": "Database operations pour projet Supabase",
          "auto_load_when": ".supabase/ exists in project",
          "config_template": "~/.xroads/mcp/supabase.template.json",
          "env_injection": {
            "SUPABASE_PROJECT_URL": "from .env or .xroads/project.json",
            "SUPABASE_ANON_KEY": "from .env"
          }
        }
      }
    },

    "loop_variants": {
      "nexus-loop": {
        "cli": "claude",
        "existing": true,
        "path": "~/bin/nexus-loop"
      },
      "codex-loop": {
        "cli": "codex",
        "existing": true,
        "path": "~/bin/codex-loop"
      },
      "gemini-loop": {
        "cli": "gemini",
        "existing": false,
        "base": "Ralph extension",
        "to_create": true
      }
    }
  },

  "user_stories": [
    {
      "id": "US-V4-001",
      "title": "Skills Repository Structure",
      "description": "Creer la structure du repository de skills XRoads avec format YAML",
      "priority": "critical",
      "depends_on": [],
      "status": "complete",
      "completed_at": "2026-02-04T10:55:00Z",
      "acceptance_criteria": [
        "Dossier ~/.xroads/skills/ cree avec sous-dossiers core/, automation/, project/",
        "Schema skill.yaml documente dans ~/.xroads/skills/SCHEMA.md",
        "Script d'initialisation xroads-skills-init cree",
        "Validation YAML avec yq ou equivalent"
      ],
      "files_to_create": [
        "~/.xroads/skills/SCHEMA.md",
        "~/.xroads/skills/core/.gitkeep",
        "~/.xroads/skills/automation/.gitkeep",
        "~/.xroads/skills/project/.gitkeep",
        "~/bin/xroads-skills-init"
      ],
      "unit_test": {
        "file": "tests/skills/test_repository_structure.sh",
        "name": "test_skills_repository_exists",
        "description": "Verifie que la structure du repository est correcte",
        "assertions": [
          "~/.xroads/skills/ exists",
          "~/.xroads/skills/core/ exists",
          "~/.xroads/skills/SCHEMA.md exists"
        ],
        "status": "passing"
      },
      "estimated_complexity": 3
    },
    {
      "id": "US-V4-002",
      "title": "Core Skills Definition",
      "description": "Definir les skills essentiels en format YAML avec templates multi-CLI",
      "priority": "critical",
      "depends_on": ["US-V4-001"],
      "status": "complete",
      "completed_at": "2026-02-04T11:30:00Z",
      "acceptance_criteria": [
        "commit.skill.yaml avec templates Claude/Gemini/Codex",
        "review-pr.skill.yaml avec templates Claude/Gemini/Codex",
        "prd.skill.yaml avec templates Claude/Gemini/Codex",
        "test-writer.skill.yaml avec templates Claude/Gemini/Codex",
        "code-reviewer.skill.yaml avec templates Claude/Gemini/Codex",
        "Chaque skill a les 3 templates (claude, gemini, codex)"
      ],
      "files_to_create": [
        "~/.xroads/skills/core/commit.skill.yaml",
        "~/.xroads/skills/core/review-pr.skill.yaml",
        "~/.xroads/skills/core/prd.skill.yaml",
        "~/.xroads/skills/core/test-writer.skill.yaml",
        "~/.xroads/skills/core/code-reviewer.skill.yaml"
      ],
      "unit_test": {
        "file": "tests/skills/test_core_skills.sh",
        "name": "test_core_skills_valid_yaml",
        "description": "Verifie que tous les skills core sont valides",
        "assertions": [
          "commit.skill.yaml is valid YAML",
          "All skills have claude/gemini/codex templates",
          "All skills have required_tools defined"
        ],
        "status": "passing"
      },
      "estimated_complexity": 5
    },
    {
      "id": "US-V4-003",
      "title": "Skill Template Engine",
      "description": "Implementer le moteur de conversion de templates entre formats CLI",
      "priority": "critical",
      "depends_on": ["US-V4-002"],
      "status": "complete",
      "completed_at": "2026-02-04T12:15:00Z",
      "acceptance_criteria": [
        "skill-converter.sh lit un skill.yaml et extrait le template pour un CLI donne",
        "Supporte placeholders {{context}}, {{files}}, {{branch}}",
        "Valide que le template existe pour le CLI cible",
        "Fallback: utilise template Claude si autre manquant (avec warning)"
      ],
      "files_to_create": [
        "~/.xroads/lib/skill-converter.sh",
        "~/.xroads/lib/skill-loader.sh"
      ],
      "unit_test": {
        "file": "tests/skills/test_template_engine.sh",
        "name": "test_skill_conversion",
        "description": "Verifie la conversion entre formats CLI",
        "assertions": [
          "skill-converter.sh --skill commit --cli claude returns Claude template",
          "skill-converter.sh --skill commit --cli gemini returns Gemini template",
          "skill-converter.sh --skill commit --cli codex returns Codex template"
        ],
        "status": "passing"
      },
      "estimated_complexity": 6
    },
    {
      "id": "US-V4-004",
      "title": "Dynamic MCP Configuration",
      "description": "Systeme de chargement dynamique des MCPs selon contexte",
      "priority": "high",
      "depends_on": ["US-V4-001"],
      "status": "complete",
      "completed_at": "2026-02-04T13:20:00Z",
      "acceptance_criteria": [
        "~/.xroads/mcp/ contient les configs MCP templates",
        "agent-browser.json config avec instructions de chargement",
        "supabase.template.json avec placeholders pour injection",
        "Script mcp-loader.sh detecte le contexte et charge les MCPs",
        "Support injection .env pour credentials"
      ],
      "files_to_create": [
        "~/.xroads/mcp/agent-browser.json",
        "~/.xroads/mcp/supabase.template.json",
        "~/.xroads/mcp/xroads.json",
        "~/.xroads/lib/mcp-loader.sh"
      ],
      "unit_test": {
        "file": "tests/mcp/test_mcp_loader.sh",
        "name": "test_mcp_dynamic_loading",
        "description": "Verifie le chargement dynamique des MCPs",
        "assertions": [
          "mcp-loader.sh --mcp xroads returns xroads config",
          "mcp-loader.sh --mcp supabase --project-url URL injects URL",
          "mcp-loader.sh detects .supabase/ and suggests supabase MCP"
        ],
        "status": "passing"
      },
      "estimated_complexity": 5
    },
    {
      "id": "US-V4-005",
      "title": "Secure Env Management",
      "description": "Gestion securisee des credentials pour MCPs dynamiques",
      "priority": "high",
      "depends_on": ["US-V4-004"],
      "status": "complete",
      "completed_at": "2026-02-04T14:30:00Z",
      "acceptance_criteria": [
        "~/.xroads/.env.template avec variables requises documentees",
        "Script env-loader.sh lit .env projet puis ~/.xroads/.env comme fallback",
        "Ne jamais logger les credentials",
        "Validation que les variables requises sont presentes",
        "Support fichiers .env.local pour overrides"
      ],
      "files_to_create": [
        "~/.xroads/.env.template",
        "~/.xroads/lib/env-loader.sh"
      ],
      "unit_test": {
        "file": "tests/env/test_env_loader.sh",
        "name": "test_env_secure_loading",
        "description": "Verifie le chargement securise des variables",
        "assertions": [
          "env-loader.sh reads project .env first",
          "env-loader.sh falls back to ~/.xroads/.env",
          "env-loader.sh validates required vars exist"
        ],
        "status": "passing"
      },
      "estimated_complexity": 4
    },
    {
      "id": "US-V4-006",
      "title": "Gemini Loop Base Implementation",
      "description": "Creer gemini-loop base sur Ralph avec patterns Nexus",
      "priority": "critical",
      "depends_on": ["US-V4-003", "US-V4-004"],
      "status": "complete",
      "completed_at": "2026-02-04T15:45:00Z",
      "acceptance_criteria": [
        "gemini-loop script cree dans ~/bin/",
        "Utilise gemini CLI avec extensions Ralph",
        "Lit PRD_FILE, PROGRESS_FILE, AGENTS_FILE comme nexus-loop",
        "Charge skills via skill-loader.sh avec format Gemini",
        "Charge MCPs dynamiques via mcp-loader.sh",
        "Emet logs vers xroads-mcp"
      ],
      "files_to_create": [
        "~/bin/gemini-loop"
      ],
      "files_to_modify": [],
      "unit_test": {
        "file": "tests/loops/test_gemini_loop.sh",
        "name": "test_gemini_loop_init",
        "description": "Verifie l'initialisation de gemini-loop",
        "assertions": [
          "gemini-loop --help shows usage",
          "gemini-loop checks for gemini CLI",
          "gemini-loop loads skills in Gemini format"
        ],
        "status": "passing"
      },
      "estimated_complexity": 8
    },
    {
      "id": "US-V4-007",
      "title": "Loop Skill Injection",
      "description": "Injecter les skills au demarrage de chaque loop",
      "priority": "high",
      "depends_on": ["US-V4-003", "US-V4-006"],
      "status": "complete",
      "completed_at": "2026-02-04T16:15:00Z",
      "acceptance_criteria": [
        "nexus-loop charge skills au startup via skill-loader.sh",
        "codex-loop charge skills au startup via skill-loader.sh",
        "gemini-loop charge skills au startup via skill-loader.sh",
        "Skills injectes dans AGENT.md ou equivalent par CLI",
        "Support --skills flag pour specifier skills additionnels"
      ],
      "files_to_modify": [
        "~/bin/nexus-loop",
        "~/bin/codex-loop",
        "~/bin/gemini-loop"
      ],
      "files_to_create": [],
      "unit_test": {
        "file": "tests/loops/test_skill_injection.sh",
        "name": "test_loops_inject_skills",
        "description": "Verifie l'injection des skills dans les loops",
        "assertions": [
          "nexus-loop --skills commit,prd loads specified skills",
          "AGENT.md contains skill instructions after init",
          "Skills are CLI-format specific"
        ],
        "status": "passing"
      },
      "estimated_complexity": 5
    },
    {
      "id": "US-V4-008",
      "title": "AgentBrowser Skill",
      "description": "Skill automation pour browser avec AgentBrowser MCP",
      "priority": "medium",
      "depends_on": ["US-V4-002", "US-V4-004"],
      "status": "pending",
      "acceptance_criteria": [
        "agent-browser.skill.yaml cree avec templates multi-CLI",
        "Depend de agent-browser MCP",
        "Instructions pour E2E testing, screenshots, form filling",
        "Auto-charge MCP agent-browser quand skill utilise"
      ],
      "files_to_create": [
        "~/.xroads/skills/automation/agent-browser.skill.yaml"
      ],
      "unit_test": {
        "file": "tests/skills/test_agent_browser_skill.sh",
        "name": "test_agent_browser_skill",
        "description": "Verifie le skill agent-browser",
        "assertions": [
          "agent-browser.skill.yaml is valid",
          "mcp_dependencies includes agent-browser",
          "All CLI templates present"
        ],
        "status": "pending"
      },
      "estimated_complexity": 4
    },
    {
      "id": "US-V4-009",
      "title": "Supabase Skill",
      "description": "Skill automation pour Supabase avec injection URL projet",
      "priority": "medium",
      "depends_on": ["US-V4-002", "US-V4-004", "US-V4-005"],
      "status": "pending",
      "acceptance_criteria": [
        "supabase-query.skill.yaml cree avec templates multi-CLI",
        "Depend de supabase MCP",
        "env_vars specifie SUPABASE_PROJECT_URL et SUPABASE_ANON_KEY",
        "Auto-detection projet Supabase via .supabase/",
        "Injection URL depuis .xroads/project.json ou .env"
      ],
      "files_to_create": [
        "~/.xroads/skills/automation/supabase-query.skill.yaml"
      ],
      "unit_test": {
        "file": "tests/skills/test_supabase_skill.sh",
        "name": "test_supabase_skill",
        "description": "Verifie le skill supabase",
        "assertions": [
          "supabase-query.skill.yaml is valid",
          "env_vars includes SUPABASE_PROJECT_URL",
          "mcp_dependencies includes supabase"
        ],
        "status": "pending"
      },
      "estimated_complexity": 4
    },
    {
      "id": "US-V4-010",
      "title": "XRoads MCP Integration",
      "description": "Integrer xroads-mcp dans toutes les loops pour logging unifie",
      "priority": "high",
      "depends_on": ["US-V4-004", "US-V4-007"],
      "status": "pending",
      "acceptance_criteria": [
        "xroads-mcp toujours charge dans toutes les loops",
        "Loops emettent logs via emit_log tool",
        "Loops emettent status via update_status tool",
        "XRoads UI recoit les logs en temps reel",
        "Skill xroads-log.skill.yaml pour instructions de logging"
      ],
      "files_to_create": [
        "~/.xroads/skills/core/xroads-log.skill.yaml"
      ],
      "files_to_modify": [
        "~/bin/nexus-loop",
        "~/bin/codex-loop",
        "~/bin/gemini-loop"
      ],
      "unit_test": {
        "file": "tests/mcp/test_xroads_mcp_integration.sh",
        "name": "test_xroads_logging",
        "description": "Verifie l'integration xroads-mcp",
        "assertions": [
          "xroads-mcp is always loaded by loops",
          "emit_log is called during loop execution",
          "update_status is called on story completion"
        ],
        "status": "pending"
      },
      "estimated_complexity": 5
    },
    {
      "id": "US-V4-011",
      "title": "Project Skills Configuration",
      "description": "Support skills specifiques au projet via .xroads/skills.json",
      "priority": "medium",
      "depends_on": ["US-V4-003"],
      "status": "pending",
      "acceptance_criteria": [
        ".xroads/skills.json schema documente",
        "skill-loader.sh lit skills projet en plus des skills globaux",
        "Skills projet overrident skills globaux du meme ID",
        "Support skills inline dans skills.json ou reference fichiers .skill.yaml"
      ],
      "files_to_create": [
        "~/.xroads/skills/project/PROJECT_SKILLS.md"
      ],
      "files_to_modify": [
        "~/.xroads/lib/skill-loader.sh"
      ],
      "unit_test": {
        "file": "tests/skills/test_project_skills.sh",
        "name": "test_project_skill_override",
        "description": "Verifie le chargement des skills projet",
        "assertions": [
          ".xroads/skills.json is loaded if exists",
          "Project skills override global skills",
          "skill-loader.sh merges both sources"
        ],
        "status": "pending"
      },
      "estimated_complexity": 4
    },
    {
      "id": "US-V4-012",
      "title": "CLI Auto-Detection",
      "description": "Detection automatique du CLI disponible pour loop generique",
      "priority": "low",
      "depends_on": ["US-V4-006", "US-V4-007"],
      "status": "pending",
      "acceptance_criteria": [
        "xroads-loop script generique cree",
        "Detecte CLI disponible: claude > gemini > codex (ordre preference)",
        "Permet override via --cli flag",
        "Charge skills dans format du CLI detecte"
      ],
      "files_to_create": [
        "~/bin/xroads-loop"
      ],
      "unit_test": {
        "file": "tests/loops/test_cli_detection.sh",
        "name": "test_auto_cli_detection",
        "description": "Verifie la detection automatique du CLI",
        "assertions": [
          "xroads-loop detects available CLI",
          "xroads-loop --cli gemini forces Gemini",
          "Error if no CLI available"
        ],
        "status": "pending"
      },
      "estimated_complexity": 3
    }
  ],

  "implementation_phases": [
    {
      "phase": 1,
      "name": "Foundation - Skills Repository",
      "stories": ["US-V4-001", "US-V4-002"],
      "goal": "Structure de base et skills core definis"
    },
    {
      "phase": 2,
      "name": "Template Engine & MCP",
      "stories": ["US-V4-003", "US-V4-004", "US-V4-005"],
      "goal": "Conversion skills et chargement MCPs dynamique"
    },
    {
      "phase": 3,
      "name": "Gemini Loop",
      "stories": ["US-V4-006"],
      "goal": "gemini-loop fonctionnel avec patterns Nexus"
    },
    {
      "phase": 4,
      "name": "Loop Integration",
      "stories": ["US-V4-007", "US-V4-010"],
      "goal": "Injection skills et logging xroads-mcp"
    },
    {
      "phase": 5,
      "name": "Automation Skills",
      "stories": ["US-V4-008", "US-V4-009"],
      "goal": "Skills AgentBrowser et Supabase"
    },
    {
      "phase": 6,
      "name": "Polish",
      "stories": ["US-V4-011", "US-V4-012"],
      "goal": "Skills projet et loop generique"
    }
  ],

  "skill_yaml_example": {
    "file": "commit.skill.yaml",
    "content": "id: commit\nname: Git Commit\nversion: 1.0.0\ndescription: Create a conventional commit from staged changes\ncategory: core\n\ntemplates:\n  claude: |\n    # /commit Skill\n    Analyze staged changes with `git diff --cached` and create a commit.\n    Follow Conventional Commits: type(scope): description\n    Types: feat, fix, docs, style, refactor, test, chore\n    Co-Authored-By: Claude <noreply@anthropic.com>\n\n  gemini: |\n    @commit Extension\n    1. Run: git diff --cached\n    2. Analyze changes and determine type/scope\n    3. Generate commit message following Conventional Commits\n    4. Execute: git commit -m \"<message>\"\n    Include: Co-Authored-By: Gemini <noreply@google.com>\n\n  codex: |\n    ## Commit Ritual\n    - codex exec \"git diff --cached\" → analyze changes\n    - Determine commit type: feat|fix|docs|style|refactor|test|chore\n    - codex exec \"git commit -m 'type(scope): description\\n\\nCo-Authored-By: Codex'\"\n\nrequired_tools:\n  - git\n  - read\n  - write\n\nmcp_dependencies: []\n\nenv_vars: []"
  },

  "gemini_loop_design": {
    "base": "Ralph extension patterns",
    "key_features": [
      "Hook-based command system (vs Claude slash commands)",
      "Extension loading via gemini CLI --load-extension",
      "System instruction injection for context",
      "Streaming output parsing for completion detection"
    ],
    "command_mapping": {
      "nexus_loop_prompt": "gemini_system_instruction",
      "claude_slash_command": "gemini_hook_trigger",
      "mcp_tool_call": "gemini_extension_function"
    }
  },

  "success_metrics": [
    "gemini-loop fonctionne avec memes patterns que nexus-loop",
    "Skills convertis automatiquement entre 3 CLIs",
    "MCPs charges dynamiquement selon contexte projet",
    "Logs unifies dans XRoads UI via xroads-mcp",
    "Credentials jamais exposes dans logs ou commits"
  ],

  "dependencies": {
    "tools": {
      "yq": "YAML parser (brew install yq)",
      "jq": "JSON parser (deja installe)",
      "gemini": "Gemini CLI",
      "claude": "Claude Code CLI",
      "codex": "Codex CLI (patched)"
    },
    "mcps": {
      "xroads-mcp": "~/Projets/CrossRoads/xroads-mcp/",
      "agent-browser": "npm i -g @anthropic/agent-browser-mcp",
      "supabase": "Supabase MCP server"
    }
  }
}
