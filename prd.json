{
  "version": "4.1",
  "feature_name": "XRoads Complete UI & Orchestrator System",
  "description": "Extension du systeme multi-CLI avec UI complete, Orchestrator Chat, Art Director pipeline et Design System as Code",
  "created_at": "2026-02-04",
  "updated_at": "2026-02-04",
  "author": "Nexus",

  "vision": {
    "summary": "XRoads devient un orchestrateur intelligent avec UI complete, chat orchestrateur et pipeline Art Direction",
    "key_concepts": [
      "Orchestrator Chat = Agent qui genere PRDs et lance les loops",
      "Art Director Pipeline = Bible → Composants → Agents utilisent",
      "Skills UI = Interface pour gerer et visualiser les skills",
      "Settings Complete = Configuration CLIs, MCPs, API keys",
      "Design System as Code = Composants generes depuis Art Direction"
    ]
  },

  "architecture": {
    "orchestrator": {
      "modes": {
        "api": {
          "purpose": "Chat rapide, generation PRD",
          "model": "claude-sonnet-4-20250514",
          "use_cases": ["PRD generation", "Quick questions", "Art bible creation"]
        },
        "terminal": {
          "purpose": "Execution complete avec tous les tools",
          "cli": "claude",
          "use_cases": ["Complex tasks", "File operations", "Loop orchestration"]
        }
      },
      "context_injection": [
        "XRoads capabilities (skills, MCPs, loops)",
        "Current project state (worktrees, branches)",
        "Available components from Art Direction"
      ]
    },

    "art_direction_pipeline": {
      "step_1": {
        "name": "Art Director Skill",
        "input": "User description or reference images",
        "output": "art-bible.json (design tokens, component specs)"
      },
      "step_2": {
        "name": "Asset PRD Generator",
        "input": "art-bible.json",
        "output": "prd-assets.json (US per component)"
      },
      "step_3": {
        "name": "Asset Loop",
        "input": "prd-assets.json",
        "output": "Generated components (Theme.swift, Colors, Typography, etc.)"
      },
      "step_4": {
        "name": "Context Injection",
        "input": "Generated components list",
        "output": "AGENTS.md with available components"
      }
    },

    "ui_structure": {
      "new_views": [
        "OrchestratorChatView",
        "SkillsBrowserView",
        "SkillDetailSheet",
        "PRDAssistantView",
        "ArtDirectionView",
        "MCPConfigPanel",
        "SettingsView (complete)"
      ],
      "modified_views": [
        "XRoadsDashboardView (add chat panel)",
        "TerminalSlotView (skills badge)",
        "GitInfoPanel (quick actions)"
      ]
    }
  },

  "user_stories": [
    {
      "id": "US-V4-013",
      "title": "Orchestrator Chat View",
      "description": "Panel de chat pour interagir avec l'orchestrateur AI",
      "priority": "critical",
      "depends_on": [],
      "status": "complete",
      "completed_at": "2026-02-04T15:30:00Z",
      "acceptance_criteria": [
        "OrchestratorChatView avec messages user/assistant",
        "Toggle API/Terminal mode",
        "Streaming response display",
        "Context aware (projet, worktrees, skills)",
        "Peut trigger actions (create PRD, launch loop)"
      ],
      "files_to_create": [
        "XRoads/Views/Orchestrator/OrchestratorChatView.swift",
        "XRoads/Views/Orchestrator/ChatMessageView.swift",
        "XRoads/Views/Orchestrator/ChatInputBar.swift",
        "XRoads/Services/OrchestratorService.swift"
      ],
      "unit_test": {
        "file": "XRoadsTests/Orchestrator/OrchestratorChatViewTests.swift",
        "name": "test_orchestrator_chat_renders",
        "description": "Verifie que le chat s'affiche correctement",
        "assertions": [
          "Chat view renders with empty state",
          "Messages display correctly",
          "Input bar accepts text"
        ],
        "status": "passing"
      },
      "estimated_complexity": 8
    },
    {
      "id": "US-V4-014",
      "title": "Orchestrator API Integration",
      "description": "Integration Anthropic API pour mode chat rapide",
      "priority": "critical",
      "depends_on": ["US-V4-013"],
      "status": "complete",
      "completed_at": "2026-02-04T13:33:00Z",
      "acceptance_criteria": [
        "AnthropicClient actor pour appels API",
        "Streaming response handling",
        "System prompt avec contexte XRoads",
        "Gestion erreurs (rate limit, auth)",
        "API key depuis Settings/Keychain"
      ],
      "files_to_create": [
        "XRoads/Services/AnthropicClient.swift",
        "XRoads/Models/ChatMessage.swift",
        "XRoads/Models/APIConfig.swift"
      ],
      "unit_test": {
        "file": "XRoadsTests/Services/AnthropicClientTests.swift",
        "name": "test_api_request_formation",
        "description": "Verifie la formation des requetes API",
        "assertions": [
          "Request includes system prompt",
          "Messages formatted correctly",
          "Streaming handled"
        ],
        "status": "passing"
      },
      "estimated_complexity": 6
    },
    {
      "id": "US-V4-015",
      "title": "Dashboard Layout with Chat Panel",
      "description": "Modifier XRoadsDashboardView pour integrer le panel chat",
      "priority": "high",
      "depends_on": ["US-V4-013"],
      "status": "complete",
      "completed_at": "2026-02-04T13:38:00Z",
      "acceptance_criteria": [
        "Panel chat a gauche (collapsible)",
        "Toggle show/hide avec raccourci (Cmd+Shift+O)",
        "Resize handle entre chat et dashboard",
        "Etat persiste entre sessions",
        "Layout adaptatif (min/max widths)"
      ],
      "files_to_modify": [
        "XRoads/Views/MainWindowView.swift"
      ],
      "files_to_create": [
        "XRoads/Views/Components/CollapsiblePanel.swift"
      ],
      "unit_test": {
        "file": "XRoadsTests/Dashboard/DashboardLayoutTests.swift",
        "name": "test_chat_panel_toggle",
        "description": "Verifie le toggle du panel chat",
        "assertions": [
          "Panel shows/hides on toggle",
          "State persists",
          "Keyboard shortcut works"
        ],
        "status": "passing"
      },
      "estimated_complexity": 5
    },
    {
      "id": "US-V4-016",
      "title": "Skills Browser View",
      "description": "Interface pour parcourir et gerer les skills disponibles",
      "priority": "high",
      "depends_on": [],
      "status": "complete",
      "completed_at": "2026-02-04T13:45:00Z",
      "acceptance_criteria": [
        "Liste skills groupes par categorie (core, automation, project)",
        "Filtre par CLI compatible (Claude, Gemini, Codex)",
        "Search par nom/description",
        "Badge installed/available",
        "Action enable/disable par projet"
      ],
      "files_to_create": [
        "XRoads/Views/Skills/SkillsBrowserView.swift",
        "XRoads/Views/Skills/SkillRowView.swift",
        "XRoads/ViewModels/SkillsViewModel.swift"
      ],
      "unit_test": {
        "file": "XRoadsTests/Skills/SkillsBrowserViewTests.swift",
        "name": "test_skills_list_renders",
        "description": "Verifie que la liste des skills s'affiche",
        "assertions": [
          "Skills grouped by category",
          "Filter by CLI works",
          "Search filters results"
        ],
        "status": "passing"
      },
      "estimated_complexity": 5
    },
    {
      "id": "US-V4-017",
      "title": "Skill Detail Sheet",
      "description": "Vue detail d'un skill avec templates et configuration",
      "priority": "medium",
      "depends_on": ["US-V4-016"],
      "status": "complete",
      "completed_at": "2026-02-04T13:52:00Z",
      "acceptance_criteria": [
        "Affiche nom, description, version",
        "Montre templates par CLI (tabs)",
        "Liste required_tools et mcp_dependencies",
        "Bouton Edit pour skills projet",
        "Preview du skill dans contexte"
      ],
      "files_to_create": [
        "XRoads/Views/Skills/SkillDetailSheet.swift",
        "XRoads/Views/Skills/SkillTemplateView.swift"
      ],
      "unit_test": {
        "file": "XRoadsTests/Skills/SkillDetailSheetTests.swift",
        "name": "test_skill_detail_displays",
        "description": "Verifie l'affichage des details skill",
        "assertions": [
          "All fields displayed",
          "Templates shown in tabs",
          "Edit button for project skills"
        ],
        "status": "passing"
      },
      "estimated_complexity": 4
    },
    {
      "id": "US-V4-018",
      "title": "Terminal Slot Skills Badge",
      "description": "Afficher les skills charges dans chaque terminal slot",
      "priority": "medium",
      "depends_on": ["US-V4-016"],
      "status": "pending",
      "acceptance_criteria": [
        "Badge avec nombre de skills charges",
        "Popover au hover avec liste skills",
        "Click ouvre SkillsBrowserView filtre par slot",
        "Indicateur si skill a probleme (MCP manquant)"
      ],
      "files_to_modify": [
        "XRoads/Views/Dashboard/TerminalSlotView.swift",
        "XRoads/Models/TerminalSlot.swift"
      ],
      "files_to_create": [
        "XRoads/Views/Components/SkillsBadge.swift"
      ],
      "unit_test": {
        "file": "XRoadsTests/Components/SkillsBadgeTests.swift",
        "name": "test_skills_badge_count",
        "description": "Verifie le badge skills",
        "assertions": [
          "Badge shows correct count",
          "Popover lists skills",
          "Warning for missing MCP"
        ],
        "status": "pending"
      },
      "estimated_complexity": 3
    },
    {
      "id": "US-V4-019",
      "title": "Settings View - General",
      "description": "Page parametres generale (theme, raccourcis, comportement)",
      "priority": "high",
      "depends_on": [],
      "status": "pending",
      "acceptance_criteria": [
        "Section Appearance (theme selection si applicable)",
        "Section Behavior (auto-start, notifications)",
        "Section Keyboard Shortcuts (editable bindings)",
        "Persistence via UserDefaults/AppStorage",
        "Reset to defaults button"
      ],
      "files_to_create": [
        "XRoads/Views/Settings/SettingsView.swift",
        "XRoads/Views/Settings/GeneralSettingsView.swift",
        "XRoads/Models/AppSettings.swift"
      ],
      "unit_test": {
        "file": "XRoadsTests/Settings/GeneralSettingsTests.swift",
        "name": "test_settings_persistence",
        "description": "Verifie la persistence des settings",
        "assertions": [
          "Settings save correctly",
          "Settings load on launch",
          "Reset works"
        ],
        "status": "pending"
      },
      "estimated_complexity": 4
    },
    {
      "id": "US-V4-020",
      "title": "Settings View - CLI Configuration",
      "description": "Configuration des CLIs (paths, options par defaut)",
      "priority": "high",
      "depends_on": ["US-V4-019"],
      "status": "pending",
      "acceptance_criteria": [
        "Path picker pour chaque CLI (Claude, Gemini, Codex)",
        "Default arguments per CLI",
        "Validation que CLI existe et fonctionne",
        "Ordre de preference pour auto-detection",
        "Test connection button"
      ],
      "files_to_create": [
        "XRoads/Views/Settings/CLISettingsView.swift"
      ],
      "files_to_modify": [
        "XRoads/Models/AppSettings.swift"
      ],
      "unit_test": {
        "file": "XRoadsTests/Settings/CLISettingsTests.swift",
        "name": "test_cli_path_validation",
        "description": "Verifie la validation des paths CLI",
        "assertions": [
          "Valid path shows green check",
          "Invalid path shows error",
          "Test connection executes CLI"
        ],
        "status": "pending"
      },
      "estimated_complexity": 4
    },
    {
      "id": "US-V4-021",
      "title": "Settings View - MCP Configuration",
      "description": "Configuration des MCPs (liste, credentials, auto-load rules)",
      "priority": "high",
      "depends_on": ["US-V4-019"],
      "status": "pending",
      "acceptance_criteria": [
        "Liste MCPs disponibles avec toggle enable/disable",
        "Config par MCP (path, arguments)",
        "Secure storage credentials via Keychain",
        "Auto-load rules editor",
        "Test MCP connection button"
      ],
      "files_to_create": [
        "XRoads/Views/Settings/MCPSettingsView.swift",
        "XRoads/Services/KeychainService.swift"
      ],
      "files_to_modify": [
        "XRoads/Models/AppSettings.swift"
      ],
      "unit_test": {
        "file": "XRoadsTests/Settings/MCPSettingsTests.swift",
        "name": "test_mcp_credential_storage",
        "description": "Verifie le stockage securise des credentials",
        "assertions": [
          "Credentials stored in Keychain",
          "Credentials retrieved correctly",
          "No plaintext storage"
        ],
        "status": "pending"
      },
      "estimated_complexity": 5
    },
    {
      "id": "US-V4-022",
      "title": "Settings View - API Keys",
      "description": "Gestion des API keys (Anthropic, OpenAI, Google)",
      "priority": "high",
      "depends_on": ["US-V4-019", "US-V4-021"],
      "status": "pending",
      "acceptance_criteria": [
        "Input securise pour API keys (masked)",
        "Storage dans Keychain",
        "Validation key format",
        "Test key button (verify with API)",
        "Support multiple keys per provider"
      ],
      "files_to_create": [
        "XRoads/Views/Settings/APIKeysSettingsView.swift"
      ],
      "unit_test": {
        "file": "XRoadsTests/Settings/APIKeysTests.swift",
        "name": "test_api_key_masked_display",
        "description": "Verifie l'affichage masque des API keys",
        "assertions": [
          "Key displayed as dots",
          "Key stored securely",
          "Validation rejects invalid format"
        ],
        "status": "pending"
      },
      "estimated_complexity": 4
    },
    {
      "id": "US-V4-023",
      "title": "PRD Assistant View",
      "description": "Interface assistee pour creer des PRDs avec l'orchestrateur",
      "priority": "critical",
      "depends_on": ["US-V4-013", "US-V4-014"],
      "status": "pending",
      "acceptance_criteria": [
        "Wizard step-by-step pour PRD creation",
        "Chat integre pour affiner avec AI",
        "Templates PRD (feature, refactor, test, assets)",
        "Preview PRD genere en temps reel",
        "Export vers prd.json et launch loop"
      ],
      "files_to_create": [
        "XRoads/Views/PRD/PRDAssistantView.swift",
        "XRoads/Views/PRD/PRDWizardSteps.swift",
        "XRoads/Views/PRD/PRDPreviewView.swift",
        "XRoads/Models/PRDTemplate.swift"
      ],
      "unit_test": {
        "file": "XRoadsTests/PRD/PRDAssistantTests.swift",
        "name": "test_prd_wizard_flow",
        "description": "Verifie le flow du wizard PRD",
        "assertions": [
          "Steps navigate correctly",
          "PRD preview updates",
          "Export creates valid JSON"
        ],
        "status": "pending"
      },
      "estimated_complexity": 7
    },
    {
      "id": "US-V4-024",
      "title": "Art Director Skill Integration",
      "description": "Integrer le skill Art Director pour generer des bibles de design",
      "priority": "high",
      "depends_on": ["US-V4-023"],
      "status": "pending",
      "acceptance_criteria": [
        "art-director.skill.yaml dans skills/core/",
        "PRD template type 'art-direction'",
        "Output art-bible.json avec design tokens",
        "Support input images/references",
        "Preview visuel des tokens generes"
      ],
      "files_to_create": [
        "~/.xroads/skills/core/art-director.skill.yaml",
        "XRoads/Views/ArtDirection/ArtBiblePreviewView.swift",
        "XRoads/Models/ArtBible.swift"
      ],
      "unit_test": {
        "file": "XRoadsTests/ArtDirection/ArtDirectorSkillTests.swift",
        "name": "test_art_bible_generation",
        "description": "Verifie la generation de l'art bible",
        "assertions": [
          "Skill loads correctly",
          "Art bible JSON valid",
          "Design tokens extractable"
        ],
        "status": "pending"
      },
      "estimated_complexity": 6
    },
    {
      "id": "US-V4-025",
      "title": "Asset PRD Generator",
      "description": "Generer un PRD de composants depuis l'art-bible",
      "priority": "high",
      "depends_on": ["US-V4-024"],
      "status": "pending",
      "acceptance_criteria": [
        "Parse art-bible.json et extrait composants",
        "Genere 1 US par composant (Theme, Colors, Typography, Buttons, etc.)",
        "Chaque US a unit_test pour valider le composant",
        "Output prd-assets.json",
        "Peut lancer loop directement"
      ],
      "files_to_create": [
        "XRoads/Services/AssetPRDGenerator.swift",
        "XRoads/Views/ArtDirection/AssetPRDPreviewView.swift"
      ],
      "unit_test": {
        "file": "XRoadsTests/ArtDirection/AssetPRDGeneratorTests.swift",
        "name": "test_prd_from_art_bible",
        "description": "Verifie la generation du PRD assets",
        "assertions": [
          "PRD contains all components from bible",
          "Each US has unit_test",
          "Output is valid PRD format"
        ],
        "status": "pending"
      },
      "estimated_complexity": 6
    },
    {
      "id": "US-V4-026",
      "title": "Component Context Injection",
      "description": "Injecter les composants disponibles dans le contexte des agents",
      "priority": "high",
      "depends_on": ["US-V4-025"],
      "status": "pending",
      "acceptance_criteria": [
        "Detecte composants generes dans le projet",
        "Ajoute section 'Available Components' dans AGENTS.md",
        "Liste composants avec usage examples",
        "Agents utilisent composants sans lire art-bible",
        "Warning si composant manquant utilise"
      ],
      "files_to_modify": [
        "~/.xroads/lib/skill-loader.sh"
      ],
      "files_to_create": [
        "XRoads/Services/ComponentContextBuilder.swift"
      ],
      "unit_test": {
        "file": "XRoadsTests/ArtDirection/ComponentContextTests.swift",
        "name": "test_component_injection",
        "description": "Verifie l'injection des composants",
        "assertions": [
          "AGENTS.md contains components section",
          "Components listed with examples",
          "Missing component triggers warning"
        ],
        "status": "pending"
      },
      "estimated_complexity": 5
    },
    {
      "id": "US-V4-027",
      "title": "Art Direction View",
      "description": "Interface complete pour le pipeline Art Direction",
      "priority": "medium",
      "depends_on": ["US-V4-024", "US-V4-025", "US-V4-026"],
      "status": "pending",
      "acceptance_criteria": [
        "Vue unifiee du pipeline Art Direction",
        "Step 1: Create/Edit Art Bible",
        "Step 2: Generate Asset PRD",
        "Step 3: Run Asset Loop",
        "Step 4: View Generated Components",
        "Progress tracking per step"
      ],
      "files_to_create": [
        "XRoads/Views/ArtDirection/ArtDirectionView.swift",
        "XRoads/Views/ArtDirection/ArtPipelineProgress.swift",
        "XRoads/ViewModels/ArtDirectionViewModel.swift"
      ],
      "unit_test": {
        "file": "XRoadsTests/ArtDirection/ArtDirectionViewTests.swift",
        "name": "test_art_pipeline_flow",
        "description": "Verifie le flow du pipeline art direction",
        "assertions": [
          "All steps accessible",
          "Progress updates correctly",
          "Components shown after generation"
        ],
        "status": "pending"
      },
      "estimated_complexity": 6
    },
    {
      "id": "US-V4-028",
      "title": "Quick Actions in GitInfoPanel",
      "description": "Actions rapides pour demarrer sans friction",
      "priority": "medium",
      "depends_on": ["US-V4-023"],
      "status": "pending",
      "acceptance_criteria": [
        "Bouton 'New Feature' → PRD Assistant",
        "Bouton 'Art Direction' → Art Direction View",
        "Bouton 'Quick Loop' → Lancer loop sur branche courante",
        "Dropdown recents PRDs pour reload rapide",
        "Context menu sur branches pour actions"
      ],
      "files_to_modify": [
        "XRoads/Views/Dashboard/GitInfoPanel.swift"
      ],
      "unit_test": {
        "file": "XRoadsTests/Dashboard/GitInfoPanelTests.swift",
        "name": "test_quick_actions",
        "description": "Verifie les quick actions",
        "assertions": [
          "New Feature opens PRD Assistant",
          "Quick Loop starts on current branch",
          "Recent PRDs listed"
        ],
        "status": "pending"
      },
      "estimated_complexity": 4
    }
  ],

  "implementation_phases": [
    {
      "phase": 7,
      "name": "Orchestrator Foundation",
      "stories": ["US-V4-013", "US-V4-014", "US-V4-015"],
      "goal": "Chat orchestrateur avec API et integration dashboard"
    },
    {
      "phase": 8,
      "name": "Skills UI",
      "stories": ["US-V4-016", "US-V4-017", "US-V4-018"],
      "goal": "Interface complete pour gerer les skills"
    },
    {
      "phase": 9,
      "name": "Settings Complete",
      "stories": ["US-V4-019", "US-V4-020", "US-V4-021", "US-V4-022"],
      "goal": "Page settings complete avec tous les parametres"
    },
    {
      "phase": 10,
      "name": "PRD & Art Direction",
      "stories": ["US-V4-023", "US-V4-024", "US-V4-025", "US-V4-026", "US-V4-027"],
      "goal": "Assistant PRD et pipeline Art Direction complet"
    },
    {
      "phase": 11,
      "name": "Quick Actions & Polish",
      "stories": ["US-V4-028"],
      "goal": "Actions rapides et finitions UX"
    }
  ],

  "completed_phases": [
    {
      "phase": 1,
      "name": "Foundation - Skills Repository",
      "stories": ["US-V4-001", "US-V4-002"],
      "status": "complete"
    },
    {
      "phase": 2,
      "name": "Template Engine & MCP",
      "stories": ["US-V4-003", "US-V4-004", "US-V4-005"],
      "status": "complete"
    },
    {
      "phase": 3,
      "name": "Gemini Loop",
      "stories": ["US-V4-006"],
      "status": "complete"
    },
    {
      "phase": 4,
      "name": "Loop Integration",
      "stories": ["US-V4-007", "US-V4-010"],
      "status": "complete"
    },
    {
      "phase": 5,
      "name": "Automation Skills",
      "stories": ["US-V4-008", "US-V4-009"],
      "status": "complete"
    },
    {
      "phase": 6,
      "name": "Polish",
      "stories": ["US-V4-011", "US-V4-012"],
      "status": "complete"
    }
  ],

  "art_bible_schema": {
    "example": {
      "project": "XRoads",
      "version": "1.0.0",
      "design_tokens": {
        "colors": {
          "background": { "primary": "#0d1117", "secondary": "#161b22" },
          "accent": { "primary": "#388bfd", "secondary": "#3fb950" },
          "text": { "primary": "#e6edf3", "secondary": "#7d8590" }
        },
        "typography": {
          "fontFamily": { "ui": "SF Pro", "mono": "SF Mono" },
          "sizes": { "xs": 10, "sm": 12, "md": 14, "lg": 16, "xl": 20 }
        },
        "spacing": { "xs": 4, "sm": 8, "md": 16, "lg": 24, "xl": 32 },
        "radius": { "sm": 4, "md": 8, "lg": 12 }
      },
      "components": [
        { "name": "PrimaryButton", "tokens": ["accent.primary", "radius.md"] },
        { "name": "Card", "tokens": ["background.secondary", "radius.lg"] },
        { "name": "Terminal", "tokens": ["background.primary", "typography.mono"] }
      ]
    }
  },

  "success_metrics": [
    "User peut demarrer feature via chat en < 30 secondes",
    "PRD genere et loop lance sans quitter l'app",
    "Art Direction → Composants en 1 pipeline",
    "Agents utilisent composants sans instructions supplementaires",
    "Settings complete et persiste correctement",
    "Skills visibles et gerables depuis l'UI"
  ],

  "total_stories": 28,
  "completed_stories": 17,
  "pending_stories": 11
}
