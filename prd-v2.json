{
  "feature_name": "CrossRoads v2 - Full Agentic Mode",
  "description": "Mode où Claude orchestre automatiquement la création de worktrees et l'assignation des tâches aux agents (Gemini, Codex) basé sur un PRD. Claude devient le chef d'orchestre qui distribue le travail et coordonne les merges.",
  "branch": "feat/full-agentic-mode",
  "created_at": "2026-02-03T06:30:00.000Z",
  "status": "complete",
  "goals": [
    "Claude orchestre automatiquement les agents Gemini et Codex",
    "Création automatique de worktrees selon le PRD",
    "Distribution intelligente des tâches par complexité",
    "Merge automatique des branches non-conflictuelles",
    "Dashboard de progression multi-agents en temps réel"
  ],
  "non_goals": [
    "Support d'autres LLMs que Claude/Gemini/Codex",
    "Résolution automatique des conflits de merge (UI manuelle)",
    "Déploiement automatique après merge"
  ],
  "prerequisites": [
    "CrossRoads v1 complète et fonctionnelle",
    "MCP Server crossroads-mcp opérationnel",
    "Au moins Claude CLI installé (Gemini/Codex optionnels)"
  ],
  "user_stories": [
    {
      "id": "US-V2-001",
      "title": "Orchestrator Protocol",
      "description": "En tant que développeur, je veux un protocole Swift pour définir le comportement de l'orchestrateur afin de pouvoir piloter plusieurs agents.",
      "priority": "critical",
      "status": "complete",
      "depends_on": [],
      "acceptance_criteria": [
        "Protocol Orchestrator avec méthodes analyzePRD, createWorktrees, assignTasks, monitorProgress, coordinateMerge",
        "Struct OrchestratorConfig avec settings (maxParallelAgents, autoMerge, conflictStrategy)",
        "Enum OrchestratorState (idle, analyzing, distributing, monitoring, merging, complete, error)",
        "Struct TaskAssignment avec storyIds, agentType, worktreePath, priority",
        "Actor ClaudeOrchestrator implémentant le protocol",
        "Le projet compile sans erreur"
      ],
      "technical_notes": "L'orchestrateur est un actor Swift qui communique avec Claude Code CLI pour prendre les décisions. Il reçoit les instructions via le MCP et les exécute.",
      "completed_at": "2026-02-03T07:45:00.000Z"
    },
    {
      "id": "US-V2-002",
      "title": "PRD Parser & Task Splitter",
      "description": "En tant qu'orchestrateur, je veux parser un PRD JSON et découper les stories en sous-tâches assignables aux agents.",
      "priority": "critical",
      "status": "complete",
      "depends_on": ["US-V2-001"],
      "acceptance_criteria": [
        "Struct PRDParser avec méthode parse(fileURL:) async throws -> PRD",
        "Méthode splitIntoTaskGroups(prd:availableAgents:) -> [TaskGroup]",
        "Struct TaskGroup avec agentType, stories, estimatedComplexity",
        "Algorithme de répartition: stories critical → Claude, high → répartition équilibrée, medium/low → Codex si disponible",
        "Validation du PRD (format, dépendances circulaires, etc.)",
        "Le projet compile sans erreur"
      ],
      "technical_notes": "Utiliser JSONDecoder pour parser. La répartition tient compte des dépendances entre stories (depends_on). Stories avec dépendances doivent être dans le même groupe ou séquencées.",
      "completed_at": "2026-02-03T09:05:00.000Z"
    },
    {
      "id": "US-V2-003",
      "title": "Auto Worktree Creation",
      "description": "En tant qu'orchestrateur, je veux créer automatiquement les worktrees nécessaires pour chaque agent assigné.",
      "priority": "critical",
      "status": "complete",
      "depends_on": ["US-V2-002"],
      "acceptance_criteria": [
        "Méthode createWorktreesForTasks(taskGroups:[TaskGroup], repoPath:String) async throws -> [WorktreeAssignment]",
        "Création de branches avec nommage: agent/{agentType}-{taskGroupId}",
        "Utilisation de GitService.createWorktree existant",
        "Struct WorktreeAssignment avec worktreePath, branch, agentType, taskGroup",
        "Nettoyage des worktrees orphelins au démarrage",
        "Paths déterministes: ~/.crossroads/worktrees/{repoHash}/{branch}/",
        "Le projet compile sans erreur"
      ],
      "technical_notes": "Réutiliser le pattern déterministe de Maestro (SHA256 du repo path). Gérer les erreurs si la branche existe déjà.",
      "completed_at": "2026-02-03T10:10:00.000Z"
    },
    {
      "id": "US-V2-004",
      "title": "Agent Launcher",
      "description": "En tant qu'orchestrateur, je veux lancer les agents CLI dans leurs worktrees respectifs avec les bonnes instructions.",
      "priority": "critical",
      "status": "complete",
      "depends_on": ["US-V2-003"],
      "acceptance_criteria": [
        "Méthode launchAgent(assignment:WorktreeAssignment, instructions:String) async throws -> AgentSession",
        "Génération d'instructions contextuelles pour chaque agent (stories assignées, fichiers à modifier)",
        "Utilisation de ProcessRunner et CLIAdapter existants",
        "Injection de CROSSROADS_SESSION_ID dans l'environnement",
        "Création automatique de AGENT.md dans le worktree avec le contexte",
        "Le projet compile sans erreur"
      ],
      "technical_notes": "AGENT.md contient: stories assignées, contraintes, fichiers à ne pas toucher (réservés aux autres agents). Utiliser le MCP pour le reporting.",
      "completed_at": "2026-02-03T11:30:00.000Z"
    },
    {
      "id": "US-V2-005",
      "title": "Agent Status File Polling",
      "description": "En tant qu'orchestrateur, je veux monitorer l'état des agents via des fichiers de statut pour suivre leur progression.",
      "priority": "high",
      "status": "complete",
      "depends_on": ["US-V2-004"],
      "acceptance_criteria": [
        "Actor AgentStatusMonitor avec polling toutes les 500ms",
        "Lecture de /tmp/crossroads/agents/agent-{sessionId}.json",
        "Struct AgentStatusFile avec agentId, state, message, currentStory, progress, timestamp",
        "Enum AgentState (idle, working, needs_input, blocked, finished, error)",
        "Détection des fichiers stale (> 5 min) et cleanup",
        "Émission d'événements vers l'UI via @Published ou AsyncStream",
        "Le projet compile sans erreur"
      ],
      "technical_notes": "Pattern repris de Maestro. Les agents écrivent leur statut via MCP emit_log/update_status. Le monitor lit les fichiers et met à jour l'UI.",
      "completed_at": "2026-02-03T11:00:00.000Z"
    },
    {
      "id": "US-V2-006",
      "title": "Progress Dashboard View",
      "description": "En tant qu'utilisateur, je veux voir la progression globale de tous les agents sur un dashboard pour monitorer le travail.",
      "priority": "high",
      "status": "complete",
      "depends_on": ["US-V2-005"],
      "acceptance_criteria": [
        "ProgressDashboardView avec vue d'ensemble multi-agents",
        "Carte par agent avec: nom, stories assignées, story en cours, progression %, statut",
        "Barre de progression globale (stories complétées / total)",
        "Timeline des événements récents (started, completed, error)",
        "Indicateurs visuels: vert=ok, jaune=working, rouge=error, gris=idle",
        "Refresh automatique depuis AgentStatusMonitor",
        "Le projet compile et le dashboard s'affiche"
      ],
      "technical_notes": "Utiliser LazyVGrid pour les cartes agents. Réutiliser StatusBadge de v1. Progress bar avec .progressViewStyle(.linear).",
      "completed_at": "2026-02-03T11:45:00.000Z"
    },
    {
      "id": "US-V2-007",
      "title": "Agent Communication Bus",
      "description": "En tant qu'orchestrateur, je veux un bus d'événements pour que les agents puissent communiquer entre eux.",
      "priority": "high",
      "status": "complete",
      "depends_on": ["US-V2-005"],
      "acceptance_criteria": [
        "Actor AgentEventBus pour communication inter-agents",
        "Enum AgentEvent (storyStarted, storyCompleted, blocked, needsHelp, fileModified)",
        "Méthode publish(event:AgentEvent, from:AgentId) async",
        "Méthode subscribe(agentId:AgentId) -> AsyncStream<AgentEvent>",
        "Notification à l'orchestrateur quand un agent est bloqué",
        "Historique des 100 derniers événements",
        "Le projet compile sans erreur"
      ],
      "technical_notes": "Utiliser AsyncStream pour la subscription. L'orchestrateur peut réassigner une tâche si un agent est bloqué trop longtemps.",
      "completed_at": "2026-02-03T11:48:00.000Z"
    },
    {
      "id": "US-V2-008",
      "title": "Merge Coordinator",
      "description": "En tant qu'orchestrateur, je veux coordonner le merge des branches worktrees vers la branche principale.",
      "priority": "high",
      "status": "complete",
      "depends_on": ["US-V2-007"],
      "acceptance_criteria": [
        "Actor MergeCoordinator avec logique de merge",
        "Méthode prepareMerge(worktrees:[WorktreeAssignment]) async throws -> MergePlan",
        "Méthode executeMerge(plan:MergePlan) async throws -> MergeResult",
        "Struct MergePlan avec ordre de merge, conflits potentiels détectés",
        "Struct MergeResult avec success, conflicts, mergedBranches",
        "Détection de conflits avant merge (git merge --no-commit --no-ff)",
        "Rollback si merge échoue",
        "Le projet compile sans erreur"
      ],
      "technical_notes": "Ordre de merge: par dépendances (stories sans dépendances d'abord). Utiliser GitService pour les opérations git.",
      "completed_at": "2026-02-03T12:30:00.000Z"
    },
    {
      "id": "US-V2-009",
      "title": "Conflict Resolution UI",
      "description": "En tant qu'utilisateur, je veux une interface pour résoudre les conflits de merge manuellement.",
      "priority": "medium",
      "status": "complete",
      "depends_on": ["US-V2-008"],
      "acceptance_criteria": [
        "ConflictResolutionSheet présentée quand conflits détectés",
        "Liste des fichiers en conflit avec diff preview",
        "Options: 'Keep Ours', 'Keep Theirs', 'Manual Edit'",
        "Bouton 'Open in External Editor' (VS Code, Xcode)",
        "Bouton 'Mark as Resolved' après édition manuelle",
        "Bouton 'Abort Merge' pour annuler",
        "Le projet compile et le sheet fonctionne"
      ],
      "technical_notes": "Utiliser git diff --name-only --diff-filter=U pour lister les conflits. NSWorkspace.shared.open pour ouvrir l'éditeur externe.",
      "completed_at": "2026-02-03T13:10:00.000Z"
    },
    {
      "id": "US-V2-010",
      "title": "AGENT.md Generator",
      "description": "En tant qu'orchestrateur, je veux générer un fichier AGENT.md contextuel dans chaque worktree.",
      "priority": "medium",
      "status": "complete",
      "depends_on": ["US-V2-004"],
      "acceptance_criteria": [
        "Struct AGENTFileGenerator avec méthode generate(for:TaskGroup) -> String",
        "Contenu: stories assignées avec détails, contraintes, fichiers réservés",
        "Section 'DO NOT MODIFY' listant les fichiers des autres agents",
        "Section 'COORDINATION' avec instructions de communication via MCP",
        "Section 'COMPLETION' avec critères de succès",
        "Écriture dans {worktreePath}/AGENT.md",
        "Le projet compile sans erreur"
      ],
      "technical_notes": "Format Markdown. Inclure les acceptance_criteria de chaque story. L'agent lit ce fichier au démarrage pour comprendre sa mission.",
      "completed_at": "2026-02-03T11:15:00.000Z"
    },
    {
      "id": "US-V2-011",
      "title": "Notes Directory Sync",
      "description": "En tant qu'orchestrateur, je veux synchroniser un répertoire notes/ entre les sessions pour capitaliser les apprentissages.",
      "priority": "medium",
      "status": "complete",
      "depends_on": ["US-V2-010"],
      "acceptance_criteria": [
        "Création de {worktreePath}/notes/ au démarrage",
        "Fichiers: decisions.md, learnings.md, blockers.md",
        "Sync depuis le repo principal vers les worktrees au démarrage",
        "Sync depuis les worktrees vers le repo principal après merge",
        "Merge des fichiers notes (append avec timestamp)",
        "Le projet compile sans erreur"
      ],
      "technical_notes": "Les agents sont instruits d'écrire dans notes/ leurs décisions importantes. Ces notes persistent entre sessions.",
      "completed_at": "2026-02-03T13:45:00.000Z"
    },
    {
      "id": "US-V2-012",
      "title": "Full Agentic Mode Toggle",
      "description": "En tant qu'utilisateur, je veux un toggle pour activer/désactiver le mode Full Agentic dans l'UI.",
      "priority": "medium",
      "status": "complete",
      "depends_on": ["US-V2-006"],
      "acceptance_criteria": [
        "Toggle 'Full Agentic Mode' dans la toolbar",
        "Quand activé: affiche ProgressDashboard au lieu de la vue standard",
        "Quand activé: bouton 'Load PRD' pour charger un fichier prd.json",
        "Quand activé: bouton 'Start Orchestration' pour lancer",
        "Quand désactivé: mode manuel (v1) avec worktrees individuels",
        "Persistance du mode dans @AppStorage",
        "Le projet compile et le toggle fonctionne"
      ],
      "technical_notes": "Utiliser @AppStorage(\"fullAgenticMode\") var isFullAgenticMode: Bool. Conditionner l'affichage dans MainWindowView.",
      "completed_at": "2026-02-03T11:50:00.000Z"
    },
    {
      "id": "US-V2-013",
      "title": "PRD Loader UI",
      "description": "En tant qu'utilisateur, je veux charger un fichier PRD depuis l'interface pour démarrer l'orchestration.",
      "priority": "medium",
      "status": "complete",
      "depends_on": ["US-V2-012"],
      "acceptance_criteria": [
        "Bouton 'Load PRD' ouvre NSOpenPanel pour sélectionner prd.json",
        "Preview du PRD chargé: nom feature, nombre de stories, agents disponibles",
        "Affichage de la répartition proposée par TaskSplitter",
        "Bouton 'Adjust Distribution' pour modifier manuellement (optionnel)",
        "Bouton 'Start' pour lancer l'orchestration",
        "Validation du PRD avec messages d'erreur clairs",
        "Le projet compile et le loader fonctionne"
      ],
      "technical_notes": "Réutiliser le pattern de WorktreeCreateSheet. Afficher un résumé avant de lancer.",
      "completed_at": "2026-02-03T14:05:00.000Z"
    },
    {
      "id": "US-V2-014",
      "title": "Orchestration History",
      "description": "En tant qu'utilisateur, je veux voir l'historique des orchestrations passées pour suivre l'évolution du projet.",
      "priority": "low",
      "status": "complete",
      "depends_on": ["US-V2-008"],
      "acceptance_criteria": [
        "Struct OrchestrationRecord avec date, prd, agents, result, duration",
        "Persistence dans ~/.crossroads/history/orchestrations.json",
        "Vue OrchestrationHistoryView listant les runs passés",
        "Détails par run: stories complétées, erreurs, temps par agent",
        "Bouton 'Rerun' pour relancer une orchestration (optionnel)",
        "Le projet compile et l'historique s'affiche"
      ],
      "technical_notes": "Utiliser FileManager pour la persistence. Garder les 50 dernières orchestrations max.",
      "completed_at": "2026-02-03T15:20:00.000Z"
    },
    {
      "id": "US-V2-015",
      "title": "Agent Health Monitoring",
      "description": "En tant qu'orchestrateur, je veux monitorer la santé des agents et réagir aux problèmes.",
      "priority": "low",
      "status": "complete",
      "depends_on": ["US-V2-005", "US-V2-007"],
      "acceptance_criteria": [
        "Détection d'agent non-responsive (pas de mise à jour > 2 min)",
        "Détection d'agent en boucle (même message répété > 5 fois)",
        "Notification à l'utilisateur avec options: 'Wait', 'Restart', 'Reassign', 'Abort'",
        "Métriques: temps par story, taux de succès par agent",
        "Affichage des métriques dans ProgressDashboard",
        "Le projet compile sans erreur"
      ],
      "technical_notes": "L'orchestrateur peut décider de réassigner une tâche à un autre agent si l'agent courant est bloqué.",
      "completed_at": "2026-02-03T16:30:00.000Z"
    }
  ],
  "technical_considerations": [
    "Réutiliser tous les services v1 (GitService, ProcessRunner, MCPClient, CLIAdapter)",
    "L'orchestrateur est un actor Swift qui encapsule toute la logique",
    "File-based status polling (pattern Maestro) pour découplage CLI/UI",
    "AGENT.md généré automatiquement pour chaque worktree",
    "Notes directory pour capitalisation inter-sessions",
    "Merge coordonné avec détection de conflits préalable"
  ],
  "success_metrics": [
    "L'orchestration d'un PRD de 10 stories avec 3 agents fonctionne",
    "Les agents travaillent en parallèle sans conflits",
    "Le merge automatique réussit pour les cas sans conflits",
    "L'UI affiche la progression en temps réel",
    "Les conflits sont présentés à l'utilisateur pour résolution manuelle"
  ],
  "architecture_diagram": "```\n┌─────────────────────────────────────────────────────────────┐\n│                    CrossRoads v2                            │\n├─────────────────────────────────────────────────────────────┤\n│                                                              │\n│  ┌─────────────────────────────────────────────────────┐    │\n│  │            ORCHESTRATOR (Claude Code)               │    │\n│  │  - Parse PRD                                        │    │\n│  │  - Create worktrees                                 │    │\n│  │  - Assign tasks to agents                           │    │\n│  │  - Monitor progress                                 │    │\n│  │  - Coordinate merges                                │    │\n│  └─────────────────────────────────────────────────────┘    │\n│         │              │              │                      │\n│         ▼              ▼              ▼                      │\n│  ┌───────────┐  ┌───────────┐  ┌───────────┐               │\n│  │ Worktree  │  │ Worktree  │  │ Worktree  │               │\n│  │ Claude    │  │ Gemini    │  │ Codex     │               │\n│  │ US-001-005│  │ US-006-010│  │ US-011-015│               │\n│  └───────────┘  └───────────┘  └───────────┘               │\n│         │              │              │                      │\n│         └──────────────┼──────────────┘                      │\n│                        ▼                                     │\n│  ┌─────────────────────────────────────────────────────┐    │\n│  │              MERGE COORDINATOR                       │    │\n│  │  - Auto-merge non-conflicting                        │    │\n│  │  - Flag conflicts for human review                   │    │\n│  │  - Create final PR                                   │    │\n│  └─────────────────────────────────────────────────────┘    │\n│                                                              │\n└─────────────────────────────────────────────────────────────┘\n```"
}
